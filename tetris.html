<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Match Three</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;600&family=Nunito:wght@300;400;600;700;800&display=swap');

:root {
  --bg: #f2f2f7;
  --surface: rgba(255,255,255,0.85);
  --surface2: rgba(255,255,255,0.6);
  --text-primary: #1c1c1e;
  --text-secondary: #8e8e93;
  --accent: #007aff;
  --radius: 20px;
  --gem-size: min(52px, calc((100vw - 60px) / 8));
  --gap: 5px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'Nunito', -apple-system, sans-serif;
  background: var(--bg);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: hidden;
  position: relative;
}

/* Soft background blobs like iOS wallpaper */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 60% 50% at 20% 10%, rgba(120,180,255,0.35) 0%, transparent 70%),
    radial-gradient(ellipse 50% 60% at 80% 20%, rgba(200,160,255,0.25) 0%, transparent 70%),
    radial-gradient(ellipse 70% 40% at 50% 90%, rgba(100,220,200,0.2) 0%, transparent 70%),
    radial-gradient(ellipse 40% 50% at 10% 70%, rgba(255,180,100,0.15) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

.container {
  width: 100%;
  max-width: 420px;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 16px 16px;
  position: relative;
  z-index: 1;
  gap: 14px;
}

/* Top bar */
.topbar {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.app-title {
  font-size: 28px;
  font-weight: 800;
  color: var(--text-primary);
  letter-spacing: -0.5px;
}

.app-title span {
  background: linear-gradient(135deg, #007aff, #5e5ce6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Stats row */
.stats {
  width: 100%;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}

.stat-card {
  background: var(--surface);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: 0 2px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
  border: 1px solid rgba(255,255,255,0.8);
}

.stat-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 2px;
}

.stat-value {
  font-size: 22px;
  font-weight: 800;
  color: var(--text-primary);
  line-height: 1;
}

.stat-value.accent { color: var(--accent); }

/* Moves indicator dots */
.moves-dots {
  display: flex;
  gap: 4px;
  margin-top: 4px;
}
.move-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent);
  transition: all 0.3s ease;
}
.move-dot.used { background: #e5e5ea; }

/* Board */
.board-wrapper {
  background: var(--surface);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 24px;
  padding: 14px;
  box-shadow:
    0 8px 32px rgba(0,0,0,0.1),
    0 2px 8px rgba(0,0,0,0.06),
    inset 0 1px 0 rgba(255,255,255,0.9);
  border: 1px solid rgba(255,255,255,0.8);
  width: 100%;
}

.board {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: var(--gap);
  width: 100%;
}

.cell {
  aspect-ratio: 1;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: calc(var(--gem-size) * 0.5);
  cursor: pointer;
  transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1),
              box-shadow 0.15s ease,
              opacity 0.3s ease;
  position: relative;
  user-select: none;
  -webkit-user-select: none;
  will-change: transform;
}

.cell::after {
  content: '';
  position: absolute;
  top: 2px; left: 4px; right: 4px;
  height: 35%;
  border-radius: 8px 8px 50% 50%;
  background: rgba(255,255,255,0.45);
  pointer-events: none;
}

.cell:active { transform: scale(0.88); }

.cell.selected {
  transform: scale(1.12);
  box-shadow: 0 0 0 3px white, 0 0 0 5px var(--accent), 0 6px 20px rgba(0,122,255,0.3);
  z-index: 10;
}

.cell.hint {
  animation: hintPulse 0.8s ease-in-out infinite alternate;
}

@keyframes hintPulse {
  from { transform: scale(1.04); box-shadow: 0 0 0 2px rgba(0,122,255,0.3); }
  to   { transform: scale(1.1);  box-shadow: 0 0 0 3px rgba(0,122,255,0.6); }
}

.cell.matched {
  animation: matchPop 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes matchPop {
  0%   { transform: scale(1); opacity: 1; }
  40%  { transform: scale(1.25); opacity: 0.9; }
  100% { transform: scale(0); opacity: 0; }
}

.cell.falling {
  animation: fallIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes fallIn {
  from { transform: translateY(-40px) scale(0.8); opacity: 0; }
  to   { transform: translateY(0) scale(1); opacity: 1; }
}

.cell.swap-right { animation: swapRight 0.2s ease; }
.cell.swap-left  { animation: swapLeft  0.2s ease; }
.cell.swap-down  { animation: swapDown  0.2s ease; }
.cell.swap-up    { animation: swapUp    0.2s ease; }

@keyframes swapRight { 0%,100%{transform:translateX(0)} 50%{transform:translateX(calc(var(--gem-size) + var(--gap)))} }
@keyframes swapLeft  { 0%,100%{transform:translateX(0)} 50%{transform:translateX(calc(-1*(var(--gem-size) + var(--gap))))} }
@keyframes swapDown  { 0%,100%{transform:translateY(0)} 50%{transform:translateY(calc(var(--gem-size) + var(--gap)))} }
@keyframes swapUp    { 0%,100%{transform:translateY(0)} 50%{transform:translateY(calc(-1*(var(--gem-size) + var(--gap))))} }

/* Gem colors ‚Äî iOS-inspired pastel with depth */
.gem-0 { background: linear-gradient(145deg, #ff6b6b, #ee3e3e); box-shadow: 0 4px 12px rgba(238,62,62,0.35); }
.gem-1 { background: linear-gradient(145deg, #5bc5f5, #2296d6); box-shadow: 0 4px 12px rgba(34,150,214,0.35); }
.gem-2 { background: linear-gradient(145deg, #7dde8f, #34c759); box-shadow: 0 4px 12px rgba(52,199,89,0.35); }
.gem-3 { background: linear-gradient(145deg, #ffcc5c, #ff9f0a); box-shadow: 0 4px 12px rgba(255,159,10,0.35); }
.gem-4 { background: linear-gradient(145deg, #c18cf7, #af52de); box-shadow: 0 4px 12px rgba(175,82,222,0.35); }
.gem-5 { background: linear-gradient(145deg, #ffa07a, #ff6347); box-shadow: 0 4px 12px rgba(255,99,71,0.35); }

/* Score popup */
.score-popup {
  position: fixed;
  pointer-events: none;
  font-size: 20px;
  font-weight: 800;
  color: var(--accent);
  text-shadow: 0 1px 8px rgba(0,122,255,0.3);
  z-index: 100;
  animation: scoreFloat 1s ease-out forwards;
}

@keyframes scoreFloat {
  0%   { opacity: 1; transform: translateY(0) scale(1); }
  100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
}

/* Bottom pill */
.bottom-bar {
  width: 100%;
  background: var(--surface);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 18px;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 16px rgba(0,0,0,0.08);
  border: 1px solid rgba(255,255,255,0.8);
}

.btn-pill {
  background: linear-gradient(135deg, #007aff, #5e5ce6);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 10px 22px;
  font-family: 'Nunito', sans-serif;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 14px rgba(0,122,255,0.35);
  transition: transform 0.15s, box-shadow 0.15s;
  letter-spacing: -0.2px;
}

.btn-pill:active { transform: scale(0.95); box-shadow: 0 2px 8px rgba(0,122,255,0.25); }

.target-info {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 600;
}

.target-info strong {
  color: var(--text-primary);
  font-weight: 800;
}

/* Game over / Win modal */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.modal-backdrop.show { opacity: 1; pointer-events: all; }

.modal {
  background: var(--surface);
  border-radius: 28px;
  padding: 32px 28px;
  width: min(320px, 90vw);
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  border: 1px solid rgba(255,255,255,0.9);
  transform: scale(0.85) translateY(20px);
  transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.modal-backdrop.show .modal { transform: scale(1) translateY(0); }

.modal-emoji { font-size: 56px; margin-bottom: 12px; }
.modal-title { font-size: 26px; font-weight: 800; color: var(--text-primary); margin-bottom: 6px; }
.modal-sub { font-size: 15px; color: var(--text-secondary); margin-bottom: 24px; font-weight: 500; }

.modal-btn {
  width: 100%;
  background: linear-gradient(135deg, #007aff, #5e5ce6);
  color: white;
  border: none;
  border-radius: 14px;
  padding: 14px;
  font-family: 'Nunito', sans-serif;
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(0,122,255,0.35);
  transition: transform 0.15s;
}
.modal-btn:active { transform: scale(0.97); }

/* Progress bar */
.progress-track {
  width: 100%;
  height: 6px;
  background: rgba(0,0,0,0.08);
  border-radius: 10px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  border-radius: 10px;
  background: linear-gradient(90deg, #007aff, #5e5ce6);
  transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 0 8px rgba(0,122,255,0.4);
}
</style>
</head>
<body>

<div class="container">
  <div class="topbar">
    <div class="app-title"><span>Match</span> Three</div>
    <div id="comboDisplay" style="font-size:13px;font-weight:700;color:#007aff;opacity:0;transition:opacity 0.3s"></div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">–°—á—ë—Ç</div>
      <div class="stat-value accent" id="scoreVal">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">–¶–µ–ª—å</div>
      <div class="stat-value" id="targetVal">500</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">–•–æ–¥—ã</div>
      <div class="stat-value" id="movesVal">20</div>
    </div>
  </div>

  <div class="progress-track">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>

  <div class="board-wrapper">
    <div class="board" id="board"></div>
  </div>

  <div class="bottom-bar">
    <div class="target-info">–ù–∞–±–µ—Ä–∏ <strong id="targetLabel">500</strong> –æ—á–∫–æ–≤</div>
    <button class="btn-pill" onclick="initGame()">–°–Ω–∞—á–∞–ª–∞</button>
  </div>
</div>

<div class="modal-backdrop" id="modal">
  <div class="modal">
    <div class="modal-emoji" id="modalEmoji">üéâ</div>
    <div class="modal-title" id="modalTitle">–ü–æ–±–µ–¥–∞!</div>
    <div class="modal-sub" id="modalSub">–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
    <button class="modal-btn" onclick="initGame()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  </div>
</div>

<script>
if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); }

const COLS = 8, ROWS = 8, GEM_TYPES = 6;
const TARGET = 500, MAX_MOVES = 20;
const EMOJIS = ['üçé','üíé','üçÄ','‚≠ê','üîÆ','üî•'];

let board = [], selected = null, score = 0, moves = MAX_MOVES, busy = false, combo = 0;

function initGame() {
  score = 0; moves = MAX_MOVES; selected = null; busy = false; combo = 0;
  board = Array.from({length: ROWS}, () =>
    Array.from({length: COLS}, () => Math.floor(Math.random() * GEM_TYPES))
  );
  // ensure no initial matches
  for (let r = 0; r < ROWS; r++)
    for (let c = 0; c < COLS; c++)
      while (checkMatchAt(r, c)) board[r][c] = Math.floor(Math.random() * GEM_TYPES);

  document.getElementById('modal').classList.remove('show');
  updateUI();
  renderBoard();
}

function checkMatchAt(r, c) {
  const v = board[r][c];
  const h = (c >= 2 && board[r][c-1] === v && board[r][c-2] === v) ||
            (c >= 1 && c < COLS-1 && board[r][c-1] === v && board[r][c+1] === v) ||
            (c < COLS-2 && board[r][c+1] === v && board[r][c+2] === v);
  const vt = (r >= 2 && board[r-1][c] === v && board[r-2][c] === v) ||
             (r >= 1 && r < ROWS-1 && board[r-1][c] === v && board[r+1][c] === v) ||
             (r < ROWS-2 && board[r+1][c] === v && board[r+2][c] === v);
  return h || vt;
}

function renderBoard() {
  const el = document.getElementById('board');
  el.innerHTML = '';
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const cell = document.createElement('div');
      cell.className = `cell gem-${board[r][c]}`;
      cell.textContent = EMOJIS[board[r][c]];
      cell.dataset.r = r; cell.dataset.c = c;
      cell.addEventListener('pointerdown', onCellClick);
      el.appendChild(cell);
    }
  }
}

function getCellEl(r, c) {
  return document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
}

function onCellClick(e) {
  if (busy) return;
  const r = +e.currentTarget.dataset.r;
  const c = +e.currentTarget.dataset.c;

  if (!selected) {
    selected = {r, c};
    getCellEl(r, c)?.classList.add('selected');
    return;
  }

  const {r: sr, c: sc} = selected;
  getCellEl(sr, sc)?.classList.remove('selected');

  if (sr === r && sc === c) { selected = null; return; }

  const dr = Math.abs(r - sr), dc = Math.abs(c - sc);
  if (dr + dc !== 1) {
    // reselect
    selected = {r, c};
    getCellEl(r, c)?.classList.add('selected');
    return;
  }

  selected = null;
  doSwap(sr, sc, r, c);
}

async function doSwap(r1, c1, r2, c2) {
  busy = true;
  combo = 0;

  // animate swap
  animateSwap(r1, c1, r2, c2);
  await delay(220);

  // swap in data
  [board[r1][c1], board[r2][c2]] = [board[r2][c2], board[r1][c1]];

  const matched = findMatches();
  if (matched.length === 0) {
    // swap back
    [board[r1][c1], board[r2][c2]] = [board[r2][c2], board[r1][c1]];
    animateSwap(r2, c2, r1, c1);
    await delay(220);
    renderBoard();
    busy = false;
    return;
  }

  moves--;
  updateUI();
  await processMatches();
  renderBoard();

  if (score >= TARGET) { showModal(true); busy = false; return; }
  if (moves <= 0) { showModal(false); busy = false; return; }
  busy = false;
}

function animateSwap(r1, c1, r2, c2) {
  const el1 = getCellEl(r1, c1), el2 = getCellEl(r2, c2);
  if (!el1 || !el2) return;
  const dc = c2 - c1, dr = r2 - r1;
  if (dc === 1) { el1.classList.add('swap-right'); el2.classList.add('swap-left'); }
  else if (dc === -1) { el1.classList.add('swap-left'); el2.classList.add('swap-right'); }
  else if (dr === 1) { el1.classList.add('swap-down'); el2.classList.add('swap-up'); }
  else { el1.classList.add('swap-up'); el2.classList.add('swap-down'); }
}

function findMatches() {
  const matched = new Set();
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS - 2; c++) {
      if (board[r][c] === board[r][c+1] && board[r][c] === board[r][c+2]) {
        matched.add(`${r},${c}`); matched.add(`${r},${c+1}`); matched.add(`${r},${c+2}`);
      }
    }
  }
  for (let c = 0; c < COLS; c++) {
    for (let r = 0; r < ROWS - 2; r++) {
      if (board[r][c] === board[r+1][c] && board[r][c] === board[r+2][c]) {
        matched.add(`${r},${c}`); matched.add(`${r+1},${c}`); matched.add(`${r+2},${c}`);
      }
    }
  }
  return [...matched].map(k => k.split(',').map(Number));
}

async function processMatches() {
  let matched;
  while ((matched = findMatches()).length > 0) {
    combo++;
    const pts = matched.length * 10 * combo;
    score += pts;
    showScorePopup(pts, combo);
    if (combo > 1) showCombo(combo);
    updateUI();

    // mark matched cells
    renderBoard();
    matched.forEach(([r, c]) => getCellEl(r, c)?.classList.add('matched'));
    await delay(380);

    // remove matched
    matched.forEach(([r, c]) => { board[r][c] = -1; });

    // gravity
    for (let c = 0; c < COLS; c++) {
      let empty = ROWS - 1;
      for (let r = ROWS - 1; r >= 0; r--) {
        if (board[r][c] !== -1) { board[empty][c] = board[r][c]; if (empty !== r) board[r][c] = -1; empty--; }
      }
      for (let r = empty; r >= 0; r--) board[r][c] = Math.floor(Math.random() * GEM_TYPES);
    }

    renderBoard();
    document.querySelectorAll('.cell').forEach(el => el.classList.add('falling'));
    await delay(320);
  }
}

function showScorePopup(pts, combo) {
  const el = document.createElement('div');
  el.className = 'score-popup';
  el.textContent = combo > 1 ? `+${pts} üî•x${combo}` : `+${pts}`;
  el.style.cssText = `left:${30 + Math.random()*40}%;top:${40 + Math.random()*20}%;`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

function showCombo(n) {
  const el = document.getElementById('comboDisplay');
  el.textContent = `${n}x COMBO! üî•`;
  el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(() => el.style.opacity = '0', 1200);
}

function updateUI() {
  document.getElementById('scoreVal').textContent = score;
  document.getElementById('movesVal').textContent = moves;
  document.getElementById('targetVal').textContent = TARGET;
  document.getElementById('targetLabel').textContent = TARGET;
  document.getElementById('progressFill').style.width = Math.min(100, score / TARGET * 100) + '%';
}

function showModal(win) {
  document.getElementById('modalEmoji').textContent = win ? 'üéâ' : 'üòî';
  document.getElementById('modalTitle').textContent = win ? '–ü–æ–±–µ–¥–∞!' : '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞';
  document.getElementById('modalSub').textContent = win
    ? `–ù–∞–±—Ä–∞–ª ${score} –æ—á–∫–æ–≤ –∑–∞ ${MAX_MOVES - moves} —Ö–æ–¥–æ–≤!`
    : `–ù–µ —Ö–≤–∞—Ç–∏–ª–æ ${TARGET - score} –æ—á–∫–æ–≤. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë!`;
  document.getElementById('modal').classList.add('show');
  if (window.Telegram?.WebApp) Telegram.WebApp.sendData(JSON.stringify({score, moves_left: moves, win}));
}

const delay = ms => new Promise(r => setTimeout(r, ms));

// Swipe support
let touchStart = null;
document.getElementById('board').addEventListener('touchstart', e => {
  const t = e.touches[0];
  touchStart = { x: t.clientX, y: t.clientY, target: e.target };
}, { passive: true });

document.getElementById('board').addEventListener('touchend', e => {
  if (!touchStart || busy) return;
  const t = e.changedTouches[0];
  const dx = t.clientX - touchStart.x, dy = t.clientY - touchStart.y;
  const adx = Math.abs(dx), ady = Math.abs(dy);
  if (adx < 10 && ady < 10) return; // tap handled by pointerdown

  const cell = touchStart.target.closest('.cell');
  if (!cell) return;
  const r = +cell.dataset.r, c = +cell.dataset.c;
  let tr = r, tc = c;
  if (adx > ady) tc += dx > 0 ? 1 : -1;
  else tr += dy > 0 ? 1 : -1;

  if (tr >= 0 && tr < ROWS && tc >= 0 && tc < COLS) {
    if (selected) { document.querySelector('.cell.selected')?.classList.remove('selected'); selected = null; }
    doSwap(r, c, tr, tc);
  }
  touchStart = null;
}, { passive: true });

initGame();
</script>
</body>
</html>
