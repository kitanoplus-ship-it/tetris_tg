<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üê± –ö–æ—Ç–∏–∫ –∏ –°–º–µ—Ç–∞–Ω–∞</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@700;900&display=swap');

  :root {
    --cream: #FFF8E7;
    --orange: #FF6B35;
    --deep: #1A0A2E;
    --purple: #4A1A7E;
    --gold: #FFD700;
    --pink: #FF85A1;
    --green: #4ECDC4;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }

  body {
    background: var(--deep);
    font-family: 'Nunito', sans-serif;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* Stars background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(1px 1px at 20% 30%, white 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 10%, white 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 50% 60%, rgba(255,255,255,0.7) 0%, transparent 100%),
      radial-gradient(1px 1px at 10% 80%, white 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 70%, white 0%, transparent 100%),
      radial-gradient(1px 1px at 35% 15%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 65% 85%, white 0%, transparent 100%),
      radial-gradient(1px 1px at 15% 50%, rgba(255,255,255,0.6) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  #screens { width: 100%; height: 100%; position: relative; z-index: 1; }

  /* ========== SCREENS ========== */
  .screen {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .screen.active { opacity: 1; pointer-events: all; }

  /* ========== START SCREEN ========== */
  #startScreen {
    gap: 24px;
    background: radial-gradient(ellipse at 50% 30%, #2D0E5A 0%, var(--deep) 70%);
  }

  .game-title {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(14px, 4vw, 22px);
    color: var(--gold);
    text-align: center;
    line-height: 1.6;
    text-shadow: 0 0 20px rgba(255,215,0,0.5), 3px 3px 0 #8B6500;
    animation: titlePulse 2s ease-in-out infinite;
  }

  @keyframes titlePulse {
    0%, 100% { text-shadow: 0 0 20px rgba(255,215,0,0.5), 3px 3px 0 #8B6500; }
    50% { text-shadow: 0 0 40px rgba(255,215,0,0.9), 3px 3px 0 #8B6500; }
  }

  .cat-hero {
    font-size: 90px;
    animation: float 3s ease-in-out infinite;
    filter: drop-shadow(0 10px 20px rgba(255,107,53,0.4));
  }

  @keyframes float {
    0%, 100% { transform: translateY(0) rotate(-5deg); }
    50% { transform: translateY(-15px) rotate(5deg); }
  }

  .subtitle {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(8px, 2.5vw, 11px);
    color: var(--pink);
    text-align: center;
    line-height: 1.8;
  }

  .btn {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(9px, 2.5vw, 13px);
    padding: 14px 28px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s;
    letter-spacing: 1px;
  }
  .btn:active { transform: translateY(3px); box-shadow: none !important; }

  .btn-primary {
    background: var(--orange);
    color: white;
    box-shadow: 0 6px 0 #A83000, 0 8px 15px rgba(255,107,53,0.4);
  }
  .btn-secondary {
    background: var(--purple);
    color: var(--gold);
    box-shadow: 0 6px 0 #2A0A50, 0 8px 15px rgba(74,26,126,0.4);
  }

  .btn-row { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }

  /* ========== GAME SCREEN ========== */
  #gameScreen { padding: 0; background: transparent; justify-content: flex-start; }

  #hud {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px 6px;
    background: rgba(26,10,46,0.9);
    backdrop-filter: blur(10px);
    border-bottom: 2px solid var(--purple);
    position: relative;
    z-index: 10;
  }

  .hud-item {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(7px, 2vw, 10px);
    color: var(--cream);
    display: flex;
    flex-direction: column;
    gap: 3px;
    align-items: center;
  }
  .hud-item span:first-child { color: var(--gold); font-size: 0.85em; }
  .hud-val { color: white; font-size: 1.1em; }

  #lives-display { display: flex; gap: 4px; font-size: 18px; }

  #canvas-wrap {
    position: relative;
    flex: 1;
    width: 100%;
    overflow: hidden;
  }

  canvas {
    display: block;
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
    cursor: none;
  }

  /* Touch zones */
  #touch-left, #touch-right {
    position: absolute;
    bottom: 0;
    width: 50%;
    height: 40%;
    z-index: 5;
  }
  #touch-left { left: 0; }
  #touch-right { right: 0; }

  /* ========== GAME OVER SCREEN ========== */
  #gameoverScreen {
    gap: 20px;
    background: radial-gradient(ellipse at 50% 40%, #3D0A0A 0%, var(--deep) 70%);
  }

  .gameover-title {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(18px, 5vw, 28px);
    color: #FF4444;
    text-shadow: 3px 3px 0 #800000, 0 0 30px rgba(255,68,68,0.6);
    animation: shake 0.5s ease-in-out;
  }

  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-5px); }
    80% { transform: translateX(5px); }
  }

  .score-big {
    font-family: 'Press Start 2P', monospace;
    text-align: center;
    line-height: 2;
  }
  .score-big .label { font-size: clamp(8px, 2vw, 11px); color: var(--pink); }
  .score-big .value { font-size: clamp(24px, 6vw, 42px); color: var(--gold); }

  .new-record {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(10px, 3vw, 14px);
    color: var(--green);
    animation: blink 0.7s steps(1) infinite;
  }
  @keyframes blink { 50% { opacity: 0; } }

  /* ========== LEADERBOARD SCREEN ========== */
  #leaderScreen {
    gap: 16px;
    background: radial-gradient(ellipse at 50% 20%, #0A2E1A 0%, var(--deep) 70%);
    overflow-y: auto;
  }

  .leader-title {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(12px, 3.5vw, 18px);
    color: var(--gold);
    text-shadow: 2px 2px 0 #8B6500;
    text-align: center;
  }

  #leaderList {
    width: 100%;
    max-width: 420px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 60vh;
    overflow-y: auto;
    padding: 4px;
  }

  .leader-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    transition: background 0.2s;
  }
  .leader-row.top1 { background: rgba(255,215,0,0.15); border-color: var(--gold); }
  .leader-row.top2 { background: rgba(192,192,192,0.12); border-color: #C0C0C0; }
  .leader-row.top3 { background: rgba(205,127,50,0.12); border-color: #CD7F32; }
  .leader-row.me { border-color: var(--green); }

  .rank {
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    color: var(--cream);
    width: 26px;
    text-align: center;
    flex-shrink: 0;
  }
  .rank-medal { font-size: 18px; }

  .leader-name {
    font-size: 14px;
    font-weight: 900;
    color: white;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .leader-score {
    font-family: 'Press Start 2P', monospace;
    font-size: 11px;
    color: var(--gold);
    flex-shrink: 0;
  }

  .leader-empty {
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    text-align: center;
    padding: 20px;
  }

  /* Loading */
  .loading {
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    color: var(--green);
    animation: blink 1s steps(1) infinite;
  }
</style>
</head>
<body>

<div id="screens">

  <!-- START -->
  <div class="screen active" id="startScreen">
    <div class="game-title">üê± –ö–û–¢–ò–ö<br>&amp; –°–ú–ï–¢–ê–ù–ê</div>
    <div class="cat-hero">üê±</div>
    <div class="subtitle">–õ–æ–≤–∏ —Å–º–µ—Ç–∞–Ω—É!<br>–ù–µ —É—Ä–æ–Ω–∏ –Ω–∞ –ø–æ–ª!</div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="startGame()">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
      <button class="btn btn-secondary" onclick="showLeader()">üèÜ –†–ï–ö–û–†–î–´</button>
    </div>
  </div>

  <!-- GAME -->
  <div class="screen" id="gameScreen">
    <div id="hud">
      <div class="hud-item">
        <span>–û–ß–ö–ò</span>
        <span class="hud-val" id="scoreDisplay">0</span>
      </div>
      <div class="hud-item">
        <span>–ñ–ò–ó–ù–ò</span>
        <div id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      </div>
      <div class="hud-item">
        <span>–†–ï–ö–û–†–î</span>
        <span class="hud-val" id="bestDisplay">0</span>
      </div>
    </div>
    <div id="canvas-wrap">
      <canvas id="gameCanvas"></canvas>
      <div id="touch-left"></div>
      <div id="touch-right"></div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div class="screen" id="gameoverScreen">
    <div class="gameover-title">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</div>
    <div style="font-size:60px">üòø</div>
    <div class="score-big">
      <div class="label">–í–ê–® –°–ß–Å–¢</div>
      <div class="value" id="finalScore">0</div>
    </div>
    <div class="new-record" id="newRecordBadge" style="display:none">‚ú® –ù–û–í–´–ô –†–ï–ö–û–†–î! ‚ú®</div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="startGame()">‚ñ∂ –ï–©–Å –†–ê–ó</button>
      <button class="btn btn-secondary" onclick="showLeader()">üèÜ –†–ï–ö–û–†–î–´</button>
    </div>
    <button class="btn" style="background:#2A2A4A;color:#aaa;font-family:'Press Start 2P';font-size:9px;padding:10px 20px" onclick="showScreen('startScreen')">‚óÄ –ú–ï–ù–Æ</button>
  </div>

  <!-- LEADERBOARD -->
  <div class="screen" id="leaderScreen">
    <div class="leader-title">üèÜ –¢–ê–ë–õ–ò–¶–ê<br>–†–ï–ö–û–†–î–û–í</div>
    <div id="leaderList"><div class="loading">–ó–ê–ì–†–£–ó–ö–ê...</div></div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="startGame()">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
      <button class="btn btn-secondary" onclick="showScreen('startScreen')">‚óÄ –ú–ï–ù–Æ</button>
    </div>
  </div>

</div>

<script>
// ============================================================
// TELEGRAM INIT
// ============================================================
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
}

const TG_USER = tg?.initDataUnsafe?.user;
const USER_ID = TG_USER?.id || 'guest_' + Math.random().toString(36).slice(2, 8);
const USER_NAME = TG_USER ? (TG_USER.first_name + (TG_USER.last_name ? ' ' + TG_USER.last_name : '')) : '–ì–æ—Å—Ç—å';

// ============================================================
// LEADERBOARD ‚Äî localStorage (works standalone; replace with API for real bot)
// ============================================================
function getLeaderboard() {
  try { return JSON.parse(localStorage.getItem('smetan_lb') || '[]'); } catch { return []; }
}

function saveScore(score) {
  let lb = getLeaderboard();
  const idx = lb.findIndex(e => e.id == USER_ID);
  if (idx >= 0) {
    if (score > lb[idx].score) lb[idx].score = score;
  } else {
    lb.push({ id: USER_ID, name: USER_NAME, score });
  }
  lb.sort((a, b) => b.score - a.score);
  localStorage.setItem('smetan_lb', JSON.stringify(lb.slice(0, 50)));
  // Also send to bot via tg.sendData if we have tg
  if (tg && tg.sendData) {
    try { tg.sendData(JSON.stringify({ action: 'score', score, user_id: USER_ID, name: USER_NAME })); } catch {}
  }
}

function getBestScore() {
  const lb = getLeaderboard();
  const me = lb.find(e => e.id == USER_ID);
  return me ? me.score : 0;
}

// ============================================================
// SCREEN MANAGEMENT
// ============================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showLeader() {
  showScreen('leaderScreen');
  renderLeaderboard();
}

function renderLeaderboard() {
  const lb = getLeaderboard();
  const list = document.getElementById('leaderList');
  if (!lb.length) { list.innerHTML = '<div class="leader-empty">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤!<br>–°—Ç–∞–Ω—å –ø–µ—Ä–≤—ã–º üê±</div>'; return; }
  const medals = ['ü•á', 'ü•à', 'ü•â'];
  list.innerHTML = lb.slice(0, 20).map((e, i) => {
    const cls = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
    const meCls = e.id == USER_ID ? ' me' : '';
    const rank = i < 3 ? `<span class="rank rank-medal">${medals[i]}</span>` : `<span class="rank">${i + 1}</span>`;
    return `<div class="leader-row ${cls}${meCls}">
      ${rank}
      <span class="leader-name">${e.id == USER_ID ? 'üò∫ ' : ''}${escHtml(e.name)}</span>
      <span class="leader-score">${e.score}</span>
    </div>`;
  }).join('');
}

function escHtml(s) { return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }

// ============================================================
// GAME ENGINE
// ============================================================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let W, H, raf;
let score, lives, speed, spawnTimer, spawnInterval;
let cat, items, particles;
let gameRunning = false;
let moveDir = 0; // -1 left, 0 none, 1 right
let lastTime = 0;

const CAT_W = 70, CAT_H = 60;
const ITEM_SIZE = 36;
const CAT_SPEED_BASE = 280; // px/s
const FLOOR_H = 50;

// Items: emoji + points + spawn weight
const ITEMS = [
  { e: 'ü•õ', pts: 10, w: 30, bad: false },  // sour cream jar
  { e: 'üç∂', pts: 15, w: 20, bad: false },
  { e: 'üêü', pts: 25, w: 15, bad: false },  // fish bonus
  { e: '‚≠ê', pts: 50, w: 5, bad: false },   // star
  { e: 'üßÖ', pts: -10, w: 15, bad: true },  // onion ‚Äî bad
  { e: 'ü™£', pts: 0, w: 5, bad: 'life' }, // bucket = extra life
];

function resize() {
  const wrap = document.getElementById('canvas-wrap');
  W = wrap.clientWidth;
  H = wrap.clientHeight;
  canvas.width = W;
  canvas.height = H;
}

function startGame() {
  showScreen('gameScreen');
  resize();

  score = 0;
  lives = 3;
  speed = 130;
  spawnInterval = 1.8;
  spawnTimer = 0;
  items = [];
  particles = [];
  moveDir = 0;

  cat = { x: W / 2, y: H - FLOOR_H - CAT_H / 2, w: CAT_W, h: CAT_H };

  updateHUD();
  gameRunning = true;
  lastTime = performance.now();
  cancelAnimationFrame(raf);
  raf = requestAnimationFrame(loop);
}

function updateHUD() {
  document.getElementById('scoreDisplay').textContent = score;
  document.getElementById('bestDisplay').textContent = getBestScore();
  const hearts = ['‚ù§Ô∏è', '‚ù§Ô∏è', '‚ù§Ô∏è'].map((h, i) => i < lives ? h : 'üñ§').join('');
  document.getElementById('lives-display').innerHTML = hearts;
}

function weightedRandom(arr) {
  const total = arr.reduce((s, a) => s + a.w, 0);
  let r = Math.random() * total;
  for (const a of arr) { r -= a.w; if (r <= 0) return a; }
  return arr[0];
}

function spawnItem() {
  const def = weightedRandom(ITEMS);
  items.push({
    x: ITEM_SIZE / 2 + Math.random() * (W - ITEM_SIZE),
    y: -ITEM_SIZE,
    e: def.e,
    pts: def.pts,
    bad: def.bad,
    vy: speed + Math.random() * 60,
    size: ITEM_SIZE,
    angle: (Math.random() - 0.5) * 0.5,
  });
}

function loop(ts) {
  if (!gameRunning) return;
  const dt = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts;

  // Move cat
  const catSpeed = CAT_SPEED_BASE;
  cat.x += moveDir * catSpeed * dt;
  cat.x = Math.max(cat.w / 2, Math.min(W - cat.w / 2, cat.x));

  // Spawn
  spawnTimer -= dt;
  if (spawnTimer <= 0) {
    spawnItem();
    spawnTimer = spawnInterval * (0.7 + Math.random() * 0.6);
    // Gradually increase speed & frequency
    speed = Math.min(400, speed + 1.5);
    spawnInterval = Math.max(0.7, spawnInterval - 0.015);
  }

  // Update items
  for (let i = items.length - 1; i >= 0; i--) {
    const it = items[i];
    it.y += it.vy * dt;
    it.angle += 1.5 * dt;

    // Catch check
    const dx = Math.abs(it.x - cat.x);
    const dy = Math.abs(it.y - (cat.y - cat.h / 2));
    if (dx < cat.w / 2 + 5 && dy < cat.h / 2 + 5 && it.y > cat.y - cat.h) {
      // Caught!
      if (it.bad === 'life') {
        if (lives < 5) lives = Math.min(5, lives + 1);
        spawnParticles(it.x, it.y, 'üíö', 8);
      } else if (it.bad) {
        lives--;
        spawnParticles(it.x, it.y, 'üíî', 6);
        if (lives <= 0) { items.splice(i, 1); endGame(); return; }
      } else {
        score += it.pts;
        spawnParticles(it.x, it.y, it.pts >= 25 ? '‚≠ê' : '‚ú®', it.pts >= 25 ? 10 : 5);
      }
      items.splice(i, 1);
      updateHUD();
      continue;
    }

    // Missed (fell past floor)
    if (it.y > H + 20) {
      if (!it.bad) {
        lives--;
        spawnParticles(it.x, H - FLOOR_H, 'üí¶', 6);
        if (lives <= 0) { items.splice(i, 1); endGame(); return; }
        updateHUD();
      }
      items.splice(i, 1);
    }
  }

  // Particles
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vy += 300 * dt;
    p.life -= dt;
    if (p.life <= 0) particles.splice(i, 1);
  }

  draw();
  raf = requestAnimationFrame(loop);
}

function spawnParticles(x, y, e, n) {
  for (let i = 0; i < n; i++) {
    particles.push({
      x, y, e,
      vx: (Math.random() - 0.5) * 200,
      vy: -Math.random() * 250 - 80,
      life: 0.6 + Math.random() * 0.4,
      maxLife: 1,
      size: 12 + Math.random() * 10,
    });
  }
}

function draw() {
  ctx.clearRect(0, 0, W, H);

  // Background gradient
  const bg = ctx.createLinearGradient(0, 0, 0, H);
  bg.addColorStop(0, '#1A0A2E');
  bg.addColorStop(1, '#2D1060');
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, W, H);

  // Floor
  const floorGrad = ctx.createLinearGradient(0, H - FLOOR_H, 0, H);
  floorGrad.addColorStop(0, '#4A1A7E');
  floorGrad.addColorStop(1, '#2A0A5E');
  ctx.fillStyle = floorGrad;
  ctx.fillRect(0, H - FLOOR_H, W, FLOOR_H);

  // Floor line glow
  ctx.shadowColor = '#FF85A1';
  ctx.shadowBlur = 12;
  ctx.strokeStyle = '#FF85A1';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, H - FLOOR_H);
  ctx.lineTo(W, H - FLOOR_H);
  ctx.stroke();
  ctx.shadowBlur = 0;

  // Items
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  for (const it of items) {
    ctx.save();
    ctx.translate(it.x, it.y);
    ctx.rotate(it.angle);
    ctx.font = `${it.size}px serif`;
    ctx.fillText(it.e, 0, 0);
    ctx.restore();
  }

  // Cat
  ctx.save();
  ctx.translate(cat.x, cat.y);
  if (moveDir !== 0) {
    ctx.scale(moveDir < 0 ? -1 : 1, 1);
  }
  ctx.font = `${CAT_W}px serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  // Slight lean when moving
  ctx.rotate(moveDir * 0.15);
  ctx.fillText('üê±', 0, 0);
  ctx.restore();

  // Particles
  for (const p of particles) {
    const alpha = p.life / (p.maxLife || 1);
    ctx.globalAlpha = Math.min(alpha * 2, 1);
    ctx.font = `${p.size}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(p.e, p.x, p.y);
  }
  ctx.globalAlpha = 1;

  // Score combo flash
  if (score > 0 && items.length === 0) {
    // just normal state
  }
}

function endGame() {
  gameRunning = false;
  cancelAnimationFrame(raf);

  const prev = getBestScore();
  saveScore(score);

  document.getElementById('finalScore').textContent = score;
  document.getElementById('newRecordBadge').style.display = score > prev && score > 0 ? 'block' : 'none';
  showScreen('gameoverScreen');
}

// ============================================================
// CONTROLS
// ============================================================

// Keyboard
window.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft' || e.key === 'a') moveDir = -1;
  if (e.key === 'ArrowRight' || e.key === 'd') moveDir = 1;
});
window.addEventListener('keyup', e => {
  if ((e.key === 'ArrowLeft' || e.key === 'a') && moveDir === -1) moveDir = 0;
  if ((e.key === 'ArrowRight' || e.key === 'd') && moveDir === 1) moveDir = 0;
});

// Touch zones
document.getElementById('touch-left').addEventListener('touchstart', e => { e.preventDefault(); moveDir = -1; }, { passive: false });
document.getElementById('touch-left').addEventListener('touchend', e => { e.preventDefault(); if (moveDir === -1) moveDir = 0; }, { passive: false });
document.getElementById('touch-right').addEventListener('touchstart', e => { e.preventDefault(); moveDir = 1; }, { passive: false });
document.getElementById('touch-right').addEventListener('touchend', e => { e.preventDefault(); if (moveDir === 1) moveDir = 0; }, { passive: false });

// Mouse drag on canvas
let mouseDown = false;
canvas.addEventListener('mousemove', e => {
  if (!gameRunning) return;
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (W / rect.width);
  if (mx < cat.x - 20) moveDir = -1;
  else if (mx > cat.x + 20) moveDir = 1;
  else moveDir = 0;
});
canvas.addEventListener('mouseleave', () => moveDir = 0);

// Full swipe touch on canvas
canvas.addEventListener('touchmove', e => {
  if (!gameRunning) return;
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const mx = (e.touches[0].clientX - rect.left) * (W / rect.width);
  if (mx < cat.x - 20) moveDir = -1;
  else if (mx > cat.x + 20) moveDir = 1;
  else moveDir = 0;
}, { passive: false });
canvas.addEventListener('touchend', () => moveDir = 0);

window.addEventListener('resize', () => { if (gameRunning) { resize(); cat.y = H - FLOOR_H - CAT_H / 2; } });
</script>
</body>
</html>
